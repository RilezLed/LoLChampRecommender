---
title: "League Champ Recommender"
author: "Riley Ledezma"
date: '2023-02-01'
output:
  github_document:
    toc: true
    toc_depth: 1
    number_sections: true
---

```{r,echo=FALSE, results='hide',fig.keep='all',message=FALSE, include=FALSE}
#Use rvest to Obtain Static Page from RIOT
library(rvest)
library(dbplyr)
library(jsonlite)
library(ggplot2)
library(plotly)
library(hrbrthemes)
library(GGally)
library(viridis)
#library(ggrepel)
library(tidyverse)
library(spatstat)
library(fmsb)
```
# Background and Motivation
 &nbsp; &nbsp; &nbsp; &nbsp;"Hey Riley, what champ do you think I'd be good at?" I've received this question a lot from my friends who play League of Legends and in the spirit of kindness (not exhaustion), I was curious to construct a champion recommender. Using Riots champion data, I constructed a K-means clustering model to help my fellow gamers pick a new character to pick up. Below is a step-by-step guide how to build a basic recommendation system for champion selection. In the future I will use this schema to design a more rigorous model. At the end is a radar chart to compare champions to each other and a link to the shiny app which allows live manipulation of the data!

# The Data ETL

## Grabbing the Data from Riot
 &nbsp; &nbsp;  &nbsp; &nbsp;Riot has a small JSON file with pretty up-to-date information on every Champion (or Character) in League of Legends.
```{r}
#Getting JSON from RIOT
getLoLChamps<- fromJSON("http://ddragon.leagueoflegends.com/cdn/13.1.1/data/en_US/champion.json")

#Transforming JSON into usable data
champData <- getLoLChamps$data

#Refine ChampData so it grabs all their stats easily
champPri <- data.frame()

for(i in 1:length(champData)){
  #Extract List
  current_list<- champData[[i]]
  current_df <- data.frame(current_list$name,current_list$info$attack,current_list$info$defense,current_list$info$magic,current_list$info$difficulty)
  
  #Append Data 
  champPri <- rbind(champPri, current_df)
}

#Change Column Names 

colnames(champPri) <- c("ChampName","Attack","Defense","Magic","Difficulty")
```
## Data Cleaning
&nbsp; &nbsp;  &nbsp; &nbsp Within the Json file there are a few champions who have 0 values which do not makes sense (i.e Qiyana had 0 for attack). Since the data set is relatively small I was able to make a few spot corrections to the champions who I thought were off. 
```{r}
#fill in missing champ data 
replaceRows <- function(champion,attack,magic,defesne,diff){
  champPri[champPri$ChampName == champion,"Attack"] <- attack
  champPri[champPri$ChampName == champion,"Magic"] <- magic
  champPri[champPri$ChampName == champion,"Defense"] <- defesne
  champPri[champPri$ChampName == champion,"Difficulty"] <- diff
  return(champPri)
}

champPri <- replaceRows("Akshan",9,3,3,6)
champPri <- replaceRows("Qiyana",6,2,4,8)
champPri <- replaceRows("Vex",1,10,4,4)
champPri <- replaceRows("Lillia",2,10,2,8)
champPri <- replaceRows("Seraphine",3,7,4,2)
champPri <- replaceRows("Rell",3,3,8,6)
```

# Summary Of Champion Types
##  Overall Distribution of Champion Attributes
&nbsp; &nbsp;  &nbsp; &nbsp;To get a sense of the pool of champions we are picking from is it necessary to visualize the distribution of attributes. For example, if you're looking to play a different super defense heavy champ or another incredibly easy character you might be hard pressed as there a fewer high defense and easy skill character to choose from. 
```{r}
#Histograms go here for each stat; 
histAttack <- champPri %>% ggplot(aes(x=Attack)) +  geom_histogram(binwidth=1,fill="#69b3a2",color="#e9ecef", alpha=0.9) + ggtitle("Attack Rating for Champ Distribution")+ scale_color_gradient(low = "blue", high = "red")+ylim(0, 35)

histMagic<- champPri %>% ggplot(aes(x=Magic)) +  geom_histogram(binwidth=1,fill="#69b3a2",color="#e9ecef", alpha=0.9) + ggtitle("Magic Rating for Champ Distribution")+ylim(0, 35)

histDefense <- champPri %>% ggplot(aes(x=Defense)) +  geom_histogram(binwidth=1,fill="#69b3a2",color="#e9ecef", alpha=0.9) + ggtitle("Defense Rating for Champ Distribution")+ylim(0, 35)

histDifficulty <- champPri %>% ggplot(aes(x=Difficulty)) +  geom_histogram(binwidth=1,fill="#69b3a2",color="#e9ecef", alpha=0.9) + ggtitle("Difficulty Rating for Champ Distribution")+ylim(0, 35)
```

### Attack Historgram

```{r,echo=FALSE, results='hide',fig.keep='all'}
histAttack
```

&nbsp; &nbsp;  &nbsp; &nbsp;  The Attack Histogram is bimodal distribution with two peaks at around 2 and 8. Typically in League, champions are split between two sources of damage dealing: Attack or Magic. Although most champs will have a mix of both, it is apparent from this graph (and to those who play the game) that characters will skew in one direction or the other while few have a 50/50 split. 

### Magic Historgram
  
```{r,echo=FALSE, results='hide',fig.keep='all'}
histMagic
```

&nbsp; &nbsp;  &nbsp; &nbsp;Similarly, the Magic Histogram is bimodal with peaks at 3 and 7. As mentioned previously, this is to be expected since characters will always have a mix (with preference) of both magic and attack. 

### Defense Historgram

```{r,echo=FALSE, results='hide',fig.keep='all'}
histDefense
```

&nbsp; &nbsp;  &nbsp; &nbsp;  The Defense Histogram tells us that Riot has very few tanks (high defense rating characters). We can see there is a somewhat normal distribution with a center at 5, and a slight right skew. With respect to the game, most characters need at least some defense, therefore it makes sense that a majority will fall in the 3-7 range. Oftentimes, tank characters are seen as boring and slow, therefore it also makes sense that there are few values of 8,9 and 10 for Defense. 

### Difficulty Histogram

```{r,echo=FALSE, results='hide',fig.keep='all'}
histDifficulty
```

&nbsp; &nbsp;  &nbsp; &nbsp;  Observing the Difficulty Histogram, it is evident that Riot has preferred to keep a normal distribution for its champs difficulty.Players are most engaged when they are playing at their skill level, and a majority of players will fall in that middle range of expertise, therefore this distribution makes sense.There is a slight left skew, which makes sense as most players who play this game will probably surpass the beginner phase and thus would be less incline to play champs who are "easy". 

## Champ Difficulty Vs Primary Factors

&nbsp; &nbsp;  &nbsp; &nbsp;  There is an ongoing debate of which champions are the most "difficult". Below are a few scatter plots examining the other three metrics against difficult to see if there is any correlations. It should be noted that since the values found below are all discrete, there is a lot of overlapping dots. I have made each dot transparent so illustrate where there may be denser concentrations of observations. 

### Attack Vs Difficulty

&nbsp; &nbsp;  &nbsp; &nbsp;  There is no obvious correlation between Attack and Difficulty, in fact it would appear as if there is an even distribution of max difficulty across different attack values. It should be noted that the largest spread of difficulty happens around the 8 mark for Attack.

```{r}
##insert scatter plots against difficulty
attackDiff <- ggplot(champPri, aes(x=Attack, y=Difficulty)) + geom_point(color='darkred',alpha=.2)+ggtitle("Scatter plot Champ Attack Vs Difficulty")
attackDiff
```

### Magic Vs Difficulty

&nbsp; &nbsp;  &nbsp; &nbsp;  Unlike the Attack vs Difficulty scatter, the Magic vs Difficulty scatter shows that there is a slight positive correlation between Magic and Difficulty. As the character gets closer to the 9-10 range in magic, a difficulty of <4 is harder to find.However, similar to the Attack graph, a value of 8 seems to have a large spread for difficulty.  


```{r}
magicDiff <- ggplot(champPri, aes(x=Magic, y=Difficulty)) + geom_point(color='darkblue',alpha=.2)+ggtitle("Scatter plot Champ Magic Vs Difficulty")
magicDiff 
```

### Defense Vs Difficulty

&nbsp; &nbsp;  &nbsp; &nbsp;  Although the correlation is weak, there is a slight negative correlation between defense and difficulty. The largest spread happens around close to 6 defense, meaning if you want a decent range of difficulty to chose from, a slightly tankier champ may be for you. 


```{r}
defenseDiff <- ggplot(champPri, aes(x=Defense, y=Difficulty)) + geom_point(color='darkgreen',alpha=.2)+ggtitle("Scatter plot Champ Defense Vs Difficulty")
defenseDiff
```

### Attack Vs Magic

&nbsp; &nbsp;  &nbsp; &nbsp;  As tacitly known by players and Riot, the final scatter plot is evidence that there is a slight dichotomy between Attack champions and Magic champions. There appears to be a negative correlation implying you can have one or the other. As an aside, there seems to be no observations at the (5,5) coordinate implying League has no champ which is equally balanced between the two. (New Idea for a character?)

```{r}
attackMagic <- ggplot(champPri, aes(x=Attack, y=Magic)) + geom_point(color='purple',alpha=.2)+ggtitle("Scatter plot Champ Attack Vs Magic")
attackMagic
```

## Linear Regression Check

&nbsp; &nbsp;  &nbsp; &nbsp;  To validate the assertions made above, I ran a simple Linear Regression model and extracted the R2 values. Using the linear models we have a baseline to confirm the lack of (or very weak) correlation between a champions Attack, Magic or Defense stats and their difficulty. The R2 values are all low (>.1) which means most of the variability in attributes can not be well described by other attributes. The exception to this is a weak negative correlation between magic and attack a character has. 
```{r}
lmAttackDiff<- lm(Difficulty~Attack, data = champPri)
lmMagicDiff<- lm(Difficulty~Magic, data = champPri)
lmDefenseDiff <-lm(Difficulty~Defense, data = champPri)
lmAttackMag <-lm(Magic~Attack, data = champPri)

print(paste0("The R2 value for Attack on Diff is:",round(summary(lmAttackDiff)$r.squared,digits=5)))
print(paste0("The R2 value for Magic on Diff is:",round(summary(lmMagicDiff)$r.squared,digits=5)))
print(paste0("The R2 value for Defense on Diff is:",round(summary(lmDefenseDiff)$r.squared,digits=5)))
print(paste0("The R2 value for Attack on Magic is:",round(summary(lmAttackMag)$r.squared,digits=5)))


```

## Key Takeaways
&nbsp; &nbsp;  &nbsp; &nbsp;  Riot does a decent job at balancing the amount of different champions across the main 4 factors, with the exception of heavy tanks.It appears that for each champion stat you can chose, there are handful of difficulty levels to play at. Attack and Magic users both have bimodal distributions, meaning that there are a larger amount of character that skew one way or the other without reaching the extremes.Lastly, one attribute does not predict another super well meaning that if you want to play an some what difficult, 50/50 magic/attack and mild defense champion you can (I'm looking at you Bard)!



# Visualization on Each Category By Champion
&nbsp; &nbsp;  &nbsp; &nbsp;If you want a simple way choosing a champion, it may be best to start by looking at the below graphs graphs and finding a champion you already like to play then choose another with similar stats. For example, someone who play "Vayne" may want to select a champion like "Xayah" since both rank 10 in Attack. Maybe you want a champ with a difficulty of 3 who is like "Braum" so you might chose "Amumu". This method is agnostic to the role which these characters are played so be careful. Combining these stats and using more in-depth parameters would lead to a better recommendation. Use this sparingly!

&nbsp; &nbsp;  &nbsp; &nbsp;The interactive graphs below have some champions removed from the Y axis to preserve space, however when hovered will display the champion name. 

## Attack Scatter Plot by Champion
```{r}
#Dot Plots for Champs

figAttack <- plot_ly(champPri, x = ~Attack, y = ~ChampName, name = "Attack", type = 'scatter',
             mode = "markers", marker = list(color = champPri$Attack,colorscale='Viridis'))
figAttack<- layout(figAttack, yaxis = list(categoryorder = "array", categoryarray = unique(champPri$ChampName)))
figAttack
```

## Magic Scatter Plot by Champion
```{r}
figMagic <- plot_ly(champPri,x = ~Magic, y = ~ChampName, name = "Magic",type = 'scatter',
            mode = "markers", marker = list(color = champPri$Magic,colorscale='RdBu'))
figMagic<- layout(figMagic, yaxis = list(categoryorder = "array", categoryarray = unique(champPri$ChampName)))

figMagic
```


## Defense Scatter Plot by Champion
```{r}
figDefense <- plot_ly(champPri,x = ~Defense, y = ~ChampName, name = "Defense",type = 'scatter',
            mode = "markers", marker = list(color = champPri$Defense,colorscale='Blackbody'))
figDefense <- layout(figDefense , yaxis = list(categoryorder = "array", categoryarray = unique(champPri$ChampName)))

figDefense
```


## Difficulty Scatter Plot by Champion

```{r}
figDifficulty <- plot_ly(champPri,x = ~Difficulty, y = ~ChampName, name = "Difficulty",type = 'scatter',
            mode = "markers", marker = list(color = champPri$Difficulty,colorscale='Jet'))
figDifficulty<- layout(figDifficulty, yaxis = list(categoryorder = "array", categoryarray = unique(champPri$ChampName)))
figDifficulty

```

# Clustering Champions by KMeans
&nbsp; &nbsp;  &nbsp; &nbsp;To get a better picture of what champions are closely related to each other, a better approach would be to combine the 4 stats and compare the similarities between each. Using a method called K-Means we can cluster champions together in various groups based on the euclidean distance between their values. As explored earlier, Riot has done a fairly decent job of evenly distributing champions thus making K-means a good starting point.

## Clustering Justifications 
&nbsp; &nbsp;  &nbsp; &nbsp; To figure out what cluster works best, I've used the eblow method to estimate the improvement in the within-cluster sum of squares.There is no obvious elbow, so trying values 5-16 increments of 4 to visualize and see if the clusters make sense. See next section for the 3D charts.
```{r, warning=FALSE}

#Get champStats
champStats<-champPri[2:5]

# function to compute total within-cluster sum of square 
wss <- function(k) {
  kmeans(champStats, k, nstart = 25 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:30

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")


```

## Visualization of Clusters in 3D

&nbsp; &nbsp;  &nbsp; &nbsp; Below are interactive 3D graphs, which cluster based on the 4 primary stats (Attack, Defense, Magic, and Difficulty). Using these graphs, hover over a champion with a similar color to a champ you make enjoy playing to chose a new champion which may play similarly to yours. It should be noted that each clustering system is slightly different and the visualization excludes difficulty. Moreover, for each model there may be a mis-grouping that more experienced League players will understand intuitively. 

### 5 Cluster KMeans Model

```{r}
set.seed(42)
grp <- kmeans(x=champStats, centers=5, nstart=25)
grpCluster <- grp$cluster
champPri$Cluster <- grpCluster

cluster <- plot_ly(champPri,x=~Attack,y=~Magic,z=~Defense,color=~Cluster, text =paste(champPri$ChampName,"Cluster:",champPri$Cluster))
cluster <- cluster %>% add_markers()
cluster
```
&nbsp; &nbsp;  &nbsp; &nbsp; Groups decently well but there are a few obvious mis-groupings (Miss Fortune and Poppy,Sion and Seraphine...). It may be useful to explore a model with more clusters for a closer grouping.

### 8 Cluster KMeans Model

```{r}
champStats<-champPri[2:5]

set.seed(42)
grp2 <- kmeans(x=champStats, centers=8, nstart=25)
grpCluster2 <- grp2$cluster
champPri$Cluster2 <- grpCluster2

cluster2 <- plot_ly(champPri,x=~Attack,y=~Magic,z=~Defense,color=~Cluster2,text =paste(champPri$ChampName,"Cluster:",champPri$Cluster2))
cluster2 <- cluster2 %>% add_markers()
cluster2
```
&nbsp; &nbsp;  &nbsp; &nbsp; Groups a bit better than before(No Sion and Seraphine) and adds a little more nuance to the grouping.We can see groups like: Mages appear (Velkoz, Oriana, Malzahar), Fighters (Sett,Garen,Darius) and Tanks (Rammus,Galio,Rell). While there are still some mis-grouping the frequency is a lot less. It's worth is to examine a higher number of clusters to see if we can find any other patterns or know our upper limit.

### 12 Cluster KMeans Model

```{r}
champStats<-champPri[2:5]

set.seed(42)
grp3 <- kmeans(x=champStats, centers=12, nstart=25)
grpCluster3 <- grp3$cluster
champPri$Cluster3 <- grpCluster3

cluster3 <- plot_ly(champPri,x=~Attack,y=~Magic,z=~Defense,color=~Cluster3, text =paste(champPri$ChampName,"Cluster:",champPri$Cluster3))
cluster3 <- cluster3 %>% add_markers()
cluster3
```
&nbsp; &nbsp;  &nbsp; &nbsp; Examining the 3D plot the 12 cluster model gives us slightly more insight (nuanced groups) than the previous model, but the marginal gain is smaller than the gain made from 5-8 cluster centers. Emerging in this model is the separation between Tanks (Rammus,Galio, Tahm Kench) and Wardens (Rell, Leona, Braum). Moreover we start to see the Hybrid Champion pool emerge (Shaco,Bard,GP).

### 16 Cluster Model 

```{r}
set.seed(42)
grp4 <- kmeans(x=champStats, centers=16, nstart=25)
grpCluster4 <- grp4$cluster
champPri$Cluster4 <- grpCluster4

cluster4 <- plot_ly(champPri,x=~Attack,y=~Magic,z=~Defense,color=~Cluster4, text =paste(champPri$ChampName,"Cluster:",champPri$Cluster4))
cluster4 <- cluster4 %>% add_markers()
cluster4

```
&nbsp; &nbsp;  &nbsp; &nbsp; Not-surprisingly the 16 cluster model has a little more nuance than the previous 3 models. We can observe that the enchanter supports begging to have their own group (Nami,Sona,Yummi) but they are also tied in with unrelated character such as Teemo and Kennen. At this point I decided the model had reached it peak in the previous iteration (balancing nuance with sensibility).

## Numerical Analysis of Clusters
&nbsp; &nbsp;  &nbsp; &nbsp; To confirm our visual insight it is important to look at numbers such as the ratio of Between Sum of Squares (as a measure of difference between group means and total mean) and Total Sum of Squares (Between SS and Error SS). Using the ratio of BetweenSS/TotalSS in the KMeans package we can examine the incremental increase of our models ability to cluster well. 

### 5 Cluster Analysis
```{r}
set.seed(42)
print(kmeans(x=champStats, centers=5, nstart=25))
```
&nbsp; &nbsp;  &nbsp; &nbsp; The groups are all similar sizes and we have a BSS/TSS ratio of 70% indicating decent fit. Using the means chart we can see that the largest cluster/group in this model is Mages (high magic,high difficulty, low attack, low defense).


### 8 Cluster Analysis
```{r}
set.seed(42)
print(kmeans(x=champStats, centers=8, nstart=25))
```
&nbsp; &nbsp;  &nbsp; &nbsp; Upon clustering with 8 centers we can see an improvement in the BSS/TSS ratio to 78%. However now there is a significantly larger group which has 37 observations, and is characterized by high attack, mid defense, low difficulty and low magic. Most of the champs found here are Auto Attack heavy champions such as Quinn, Miss Fortune, or Varus. 


### 12 Cluster Analysis
```{r}
set.seed(42)
print(kmeans(x=champStats, centers=12, nstart=25))
```
&nbsp; &nbsp;  &nbsp; &nbsp; Comparing this model to the previous, the sizes of the groups are a little less variable and there is a marginal increase in the BSS/TSS ratio. Again the largest group seems to be Auto Attack heavy champions. As the clustering gets finer the means seem to be less descriptive of a particular group


### 16 Cluster Analysis
```{r}
set.seed(42)
print(kmeans(x=champStats, centers=16, nstart=25))
```
&nbsp; &nbsp;  &nbsp; &nbsp; Finally, comparing the 16 center model with the other we have the best ratio of BSS/TSS however the means chart gives an even less intelligible grouping for champs. 

## Takeaways from Clustering 
&nbsp; &nbsp;  &nbsp; &nbsp; The story of league champs can be explained decently well through the primary statistics (Attack,Magic,Defense,Difficulty) but it is not the complete picture. As we increased the number of cluster centers we can observe more nuanced grouping for Champions.It appears that 16 centers works the best without being too redundant or mis-grouping. When examining the numerical data from the clusters (as well as the elbow plot) we can see that the diminishing returns on increasing cluster, especially after 12 centers. 
  However, since it does do a decently good job at grouping I have integrated the 12 center Kmeans model into a recommendation system as seen below. 

# Recommender
&nbsp; &nbsp;  &nbsp; &nbsp; Below is a sample of what the recommendation system will return for the champion Heimerdinger. A radar chart will be presented to compare the recommended champions attributes to the one that is chosen. Each champ can be toggled on or off for clarity. 
```{r}
#Take in a champion
champRec <- function(champion){
  curClusterNo <- champPri[champPri$ChampName == champion,]$Cluster3
  getRec <- champPri[champPri$Cluster3 == curClusterNo,]
  getRec<- getRec[getRec$ChampName != champion,]
  champRecList<- getRec$ChampName
  champRecList <- sample(champRecList,3)
  champRecList <- append(champRecList,champion)
  return(champRecList)
}

newRec <-champRec("Heimerdinger")

colors_border=c( rgb(0.2,0.5,0.5,0.9), rgb(0.8,0.2,0.5,0.9) , rgb(0.7,0.5,0.1,0.9),rgb(0.6,0.6,0.2,0.8))
colors_in=c( rgb(0.2,0.5,0.5,0.4), rgb(0.8,0.2,0.5,0.4) , rgb(0.7,0.5,0.1,0.4),rgb(0.6,0.6,0.2,0.8))


#Change the Row name to Champ name
radarData <- champPri[champPri$ChampName %in% newRec,]
rownames(radarData) <- radarData[,1]
radarData <- radarData[,2:5]

#Create For Loop for a Radar Chart for each
radar <- plot_ly(
    type = 'scatterpolar',
    fill = 'toself',
    mode='markers' 
  ) 
for( i in 1:nrow(radarData)){
  radar <- radar %>% add_trace(
    r = c(radarData[i,]$Attack,radarData[i,]$Magic,radarData[i,]$Defense,radarData[i,]$Difficulty),
    theta = c('Attack','Magic','Defense', 'Difficulty'),
    name = rownames(radarData[i,])
  ) 
}

radar


```

# Conclusion

&nbsp; &nbsp;  &nbsp; &nbsp;League of Legends has over 162 characters and its fun to try new champs but oftentimes in hard to get a good feel who might match your playstyle. As demonstrated with the histograms and scatter plots there are plenty of options to choose from depending on your affinity for the 4 primary stats (with the exception of super tanks and very easy champs). Although one may chose based on a single stat, it is important to consider that a combination of stats would give a better idea on which character you would like to play. Although the K-means method is quick and simple to understand, it does produce the occasional odd pairing when combined with difficulty (especially when its not visualized). 
  
&nbsp; &nbsp;  &nbsp; &nbsp;To create a more in-depth recommendation system, there are more granular parameters (20 more) which can be explored such as hpperlevel, or attackspeed. Moreover, Riot has labeled each champion with tags such as "Assassin" or "Mage". These descriptive characteristics may give a better idea of who to play and will be explored in future iterations of this project.

  &nbsp; &nbsp;  &nbsp; &nbsp;For now I hope you have fun exploring the data with the interactive plots and can wrap your head around the nuanced stats/choices you have in character selection. See you on the Rift!

